# DaRoomate Production Docker Compose
#
# Usage:
#   cp env.example .env
#   # Edit .env with your values
#   docker compose -f docker-compose.production.yml up --build
#
# This file is compatible with:
# - Local testing
# - AWS ECS (via ecs-cli compose)
# - Docker Swarm

services:
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      - POSTGRESQL_HOST=${POSTGRESQL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_PORT:-5432}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE}
      - POSTGRESQL_USERNAME=${POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - JWT_KEY=${JWT_KEY}
      - ACTIVE_PROFILE=${ACTIVE_PROFILE:-prod}
      - CONTAINER_PORT=${BACKEND_PORT:-8085}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_ID=${EMAIL_ID}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
    ports:
      - "${BACKEND_PORT:-8085}:${BACKEND_PORT:-8085}"
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:${BACKEND_PORT:-8085}/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - daroomate-network

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_BASE_API_URL=${REACT_APP_BASE_API_URL:-http://localhost:8085}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:80/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - daroomate-network

networks:
  daroomate-network:
    driver: bridge

# Note: Database is expected to be external (Railway PostgreSQL, AWS RDS, etc.)
# For local development with a local database, use backend/docker/compose.yml instead
